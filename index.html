<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>差枚ヒートマップ（プリセット対応）</title>
<style>
:root {
  --cell: min(11vw, 44px);
  --fnum: clamp(6px, 0.18 * var(--cell), 11px);
  --ftitle: clamp(7px, 0.18 * var(--cell), 10px);
  --fdiff: clamp(6px, 0.18 * var(--cell), 11px);
  --cP0: #ffe6e6; --cP1: #ffb3b3; --cP2: #ff8080;
  --cP3: #ff4d4d; --cP4: #ff1a1a; --cP5: #e60000;
}
body { margin: 0; font-family: sans-serif; }
header { padding: 12px; display: flex; flex-direction: column; gap: 8px; }
textarea {
  width: calc(100% - 4px);
  height: 100px;
  font-size: 14px;
  box-sizing: border-box;
  padding: 8px;
  font-family: inherit;
  border: 1px solid #ccc;
  border-radius: 4px;
  touch-action: manipulation;
  -webkit-text-size-adjust: 100%;
}
button.parse { margin-top: 8px; height: 44px; font-size: 16px; }
#grid {
  display: grid;
  grid-auto-rows: var(--cell);
  grid-auto-columns: var(--cell);
  overflow-x: auto;
  touch-action: pan-x pan-y;
  padding-bottom: 64px;
}
.cell {
  width: var(--cell); height: var(--cell);
  box-sizing: border-box;
  border: 1px solid #ccc;
  display: grid;
  grid-template-rows: 1fr 1fr 1fr;
  place-items: center;
  text-align: center;
  overflow: hidden;
  user-select: none;
}
.cell strong { font-size: var(--fnum); }
.cell .title { font-size: var(--ftitle); color: #555; line-height: 1.05; }
.cell .diff { font-size: var(--fdiff); }
.P0 { background: var(--cP0); } .P1 { background: var(--cP1); }
.P2 { background: var(--cP2); } .P3 { background: var(--cP3); }
.P4 { background: var(--cP4); } .P5 { background: var(--cP5); }
footer {
  position: fixed; bottom: 0; left: 0; right: 0;
  display: flex; gap: 8px; padding: 8px;
  background: #fff; box-shadow: 0 -2px 4px rgba(0,0,0,.08);
  z-index: 1000;
}
footer button { flex: 1; min-height: 44px; font-size: 16px; }
#toast {
  position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%);
  background: #333; color: #fff; padding: 8px 12px; border-radius: 4px;
  font-size: 14px; opacity: 0; pointer-events: none; transition: .3s;
  z-index: 1001;
}
#toast.show { opacity: 0.9; }
</style>
</head>
<body>
<header>
  <label>フロアマッププリセット</label>
  <select id="presetSelect" onchange="loadPresetMap(this.value)">
    <option value="">-- ホールを選択 --</option>
    <option value="kamata">マルハン蒲田</option>
  </select>
  <label>フロアマップCSV（貼り付け）</label>
  <textarea id="mapText"></textarea>
  <label>差枚CSV（貼り付け）</label>
  <textarea id="samaText"></textarea>
  <button class="parse" onclick="parsePasted()">描画する</button>
</header>
<div id="grid"></div>
<footer>
  <button id="saveBtn" onclick="savePNG()" disabled>保存</button>
  <button id="resetBtn" onclick="resetAll()" disabled>リセット</button>
</footer>
<div id="toast"></div>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
const gridEl = document.getElementById('grid');
const saveBtn = document.getElementById('saveBtn');
const resetBtn = document.getElementById('resetBtn');
const toast = document.getElementById('toast');
const presets = {
  kamata: `2001,2002,2003,2004,2005,2006,2007,2008,2009,2010,2011,2012,2013,2014,2015,2016,2017,2018,2019,2020,Unnamed: 20,2021,2022,2023,2024,2025,2026,2027,2028,2029,2030,2031,Unnamed: 32,Unnamed: 33,Unnamed: 34,Unnamed: 35,Unnamed: 36,Unnamed: 37,Unnamed: 38,Unnamed: 39,Unnamed: 40
,,,2059,2058,2057,2056,2055,2054,2053,2052,2051,2050,2049,2048,2047,2046,2045,2044,2043,,2042,2041,2040,2039,2038,2037,2036,2035,2034,2033,2032,,,,,,,,,
,,,2060,2061,2062,2063,2064,2065,2066,2067,2068,2069,2070,2071,2072,2073,2074,2075,2076,,2077,2078,2079,2080,2081,2082,2083,2084,2085,2086,2087,,,,,,,,,
,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
,,,,,,,,2109,2108,2107,2106,2105,2104,2103,2102,2101,2100,2099,,2098,2097,2096,2095,2094,2093,2092,2091,2090,2089,2088,,,,,,,,,,
,,,,,,,,2110,2111,2112,2113,2114,2115,2116,2117,2118,2119,2120,,2121,2122,2123,2124,2125,2126,2127,2128,2129,2130,2131,,,,,,,,,,
,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
,,,,,,,,,,,2146,2145,2144,2143,,2142,2141,2140,2139,2138,2137,2136,2135,2134,2133,2132,,,,,,,,,,,,,,
,,,,,,,,,,,2147,2148,2149,2150,,2151,2152,2153,2154,2155,2156,2157,2158,2159,2160,2161,,,,,,,,,,,,,,
,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
,,,,,,2176,2175,2174,2173,2172,2171,2170,2169,2168,2167,,2166,2165,2164,2163,2162,,,,,,,,,,,,,,,,,,,
,,,,,,2177,2178,2179,2180,2181,2182,2183,2184,2185,2186,,2187,2188,2189,2190,,,,,,,,,,,,,,,,,,,,
,,,,,,,2176,2175,2174,2173,2172,2171,2170,2169,2168,2167,,,2202,2201,2200,2199,2198,2197,2196,2195,2194,2193,2192,2191,,,,,,,,,,
,,,,,,,2177,2178,2179,2180,2181,2182,2183,2184,2185,2186,,,2223,2224,2225,2226,2227,2228,2229,2230,2231,2232,2233,2234,2235,,,,,,,,,
,,,,,,,2212,2211,2210,2209,2208,2207,2206,2205,2204,2203,,,2255,2254,2253,2252,2251,2250,2249,2248,2247,2246,2245,2244,2243,2242,2241,2240,2239,2238,2237,2236,,
,,,,,,,2213,2214,2215,2216,2217,2218,2219,2220,2221,2222,,,2276,2277,2278,2279,2280,2281,2282,2283,2284,2285,2286,2287,2288,2289,2290,2291,2292,2293,2294,2295,,
,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
,,,,,,,2265,2264,2263,2262,2261,2260,2259,2258,2257,2256,,2221,,,,,,2310,2309,2308,2307,2306,2305,2304,2303,2302,2301,2300,2299,2298,2297,2296,,
,,,,,,,2266,2267,2268,2269,2270,2271,2272,2273,2274,2275,,2222,,,,,,,,,,,,,,,,,,,,,,
,,,,,,,,,,,,,,,,,,2223,,,,,,,,,,,,,,,,,,,,,,
,,,,,,,2320,2319,2318,2317,2316,2315,2314,2313,2312,2311,,2224,,,,,,,,,,,,,,,,,,,,,,
,,,,,,,2331,2332,2333,2334,2335,2336,2337,2338,2339,2340,,2225,,,,,,,,,,,,,,,,,,,,,,
,,,,,,,,,,,,,,,,,,2226,,,,,,,,,,,,,,,,,,,,,,
,,,,,,,2350,2349,2348,2347,2346,2345,2344,2343,2342,2341,,2227,,,,,,,,,,,,,,,,,,,,,,
,,,,,,,2351,2352,2353,2354,2355,2356,2357,2358,2359,2360,,2228,,,,,,,,,,,,,,,,,,,,,,
,,,,,,,,,,,,,,,,,,2229,,,,,,,,,,,,,,,,,,,,,,
,,,,,,,2370,2369,2368,2367,2366,2365,2364,2363,2362,2361,,2230,,,,,,,,,,,,,,,,,,,,,,`
};
function loadPresetMap(key) {
  if (presets[key]) {
    document.getElementById('mapText').value = presets[key];
  }
}

let mapData = null;
let samaDict = null;

function cleanNum(s) {
  return Number(String(s ?? '').replace(/[^\d\-]/g, '') || 0);
}

function detectDelimiter(sample){
  if(sample.includes('\t')) return '\t';
  if(sample.split('\n')[0].includes(',')) return ',';
  return Papa.RECORD_SEP;
}

function parsePasted() {
  const mapText = document.getElementById('mapText').value;
  const samaText = document.getElementById('samaText').value;
  if (!mapText || !samaText) return showToast('両方のCSVを貼り付けてください');

  Papa.parse(mapText, {
    skipEmptyLines: false,
    complete: res => {
      const raw = res.data;
      const maxLen = Math.max(...raw.map(r => r.length));
      mapData = raw.map(r => {
        const row = [...r];
        while (row.length < maxLen) row.push('');
        return row;
      });
      parseSamaText(samaText);
    }
  });
}

function parseSamaText(text) {
  const delimiter = detectDelimiter(text);
  Papa.parse(text, {
    delimiter,
    complete: res => {
      samaDict = {};
      res.data.forEach(r => {
        if (r.length < 4) return;
        const num = String(r[1]).trim();
        const diff = cleanNum(r[3]);
        if (!num) return;
        samaDict[num] = { title: String(r[0]).trim(), diff };
      });
      buildIfReady();
    }
  });
}

function buildIfReady(){
  if (!mapData || !samaDict) return;
  gridEl.innerHTML = '';
  const cols = Math.max(...mapData.map(row => row.length));
  gridEl.style.gridTemplateColumns = `repeat(${cols}, var(--cell))`;
  const found = new Set();

  mapData.forEach(row => {
    row.forEach(cell => {
      const div = document.createElement('div');
      div.className = cell ? 'cell' : '';

      if (cell) {
        const key = String(cell).trim();
        const info = samaDict[key];
        if (info) {
          found.add(key);
          const cls = diffToClass(info.diff);
          if (cls) div.classList.add(cls);
          const signed = info.diff > 0 ? `+${info.diff}` : String(info.diff);
          const short = info.title.length > 8 ? info.title.slice(0, 8) + '…' : info.title;
          div.innerHTML = `
            <strong>${key}</strong>
            <span class="title">${short}</span>
            <span class="diff">${signed}</span>`;
        } else {
          div.textContent = key;
        }
      }
      if (cell) gridEl.appendChild(div);
      else gridEl.appendChild(Object.assign(document.createElement('div'), { style: 'width: var(--cell); height: var(--cell);' }));
    });
  });

  const missing = Object.keys(samaDict).filter(k => !found.has(k));
  if (missing.length) showToast(`配置にない台番号: ${missing.slice(0, 5).join(',')}${missing.length > 5 ? '…' : ''}`);
  saveBtn.disabled = resetBtn.disabled = false;
}

function diffToClass(d){
  return d > 0 ? 'P' + Math.min(Math.floor((d - 1) / 1000), 5) : '';
}

function savePNG() {
  const clone = gridEl.cloneNode(true);
  const wrapper = document.createElement('div');
  wrapper.style.position = 'absolute';
  wrapper.style.left = '0';
  wrapper.style.top = '0';
  wrapper.style.padding = '16px';
  wrapper.style.background = '#fff';
  wrapper.appendChild(clone);
  document.body.appendChild(wrapper);

  html2canvas(wrapper, { scale: window.devicePixelRatio * 1.2 }).then(canvas => {
    canvas.toBlob(blob => {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'samamap.png';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      document.body.removeChild(wrapper);
    });
  });
}

function resetAll(){
  mapData = samaDict = null;
  document.getElementById('mapText').value = '';
  document.getElementById('samaText').value = '';
  gridEl.innerHTML = '';
  saveBtn.disabled = resetBtn.disabled = true;
  showToast('リセットしました');
}

function showToast(msg){
  toast.textContent = msg;
  toast.classList.add('show');
  clearTimeout(showToast.tid);
  showToast.tid = setTimeout(() => toast.classList.remove('show'), 3000);
}
</script>
</body>
</html>
